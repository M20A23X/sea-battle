FROM node:18 as base
WORKDIR /usr/src/app/

RUN --mount=type=cache,target=~/AppData/Local/Yarn/Cache/v4 \
    --mount=type=bind,source=lerna.json,target=lerna.json \
    --mount=type=bind,source=.yarnrc,target=.yarnrc \
    --mount=type=bind,source=.yarn,target=.yarn \
    --mount=type=bind,source=package.json,target=package.json \
    --mount=type=bind,source=packages/shared/package.json,target=packages/shared/package.json \
    --mount=type=bind,source=packages/client/package.json,target=packages/client/package.json \
    --mount=type=bind,source=yarn.lock,target=yarn.lock \
    yarn install --frozen-lockfile --non-interactive --ignore-scripts

COPY --chown=app:app ./packages/shared/src*/ ./packages/shared/src/
COPY --chown=app:app ./packages/client/src/ ./packages/client/src/
COPY --chown=app:app ./packages/client/public/ ./packages/client/public/

RUN --mount=type=cache,target=~/AppData/Local/Yarn/Cache/v4 \
    --mount=type=bind,source=lerna.json,target=lerna.json \
    --mount=type=bind,source=.eslintrc,target=.eslintrc \
    --mount=type=bind,source=package.json,target=package.json \
    --mount=type=bind,source=packages/shared/package.json,target=packages/shared/package.json \
    --mount=type=bind,source=packages/shared/tsconfig.json,target=packages/shared/tsconfig.json \
    --mount=type=bind,source=packages/client/package.json,target=packages/client/package.json \
    --mount=type=bind,source=packages/client/config-overrides.cjs,target=packages/client/config-overrides.cjs \
    --mount=type=bind,source=packages/client/tsconfig.json,target=packages/client/tsconfig.json \
    --mount=type=bind,source=packages/client/.eslintrc.cjs,target=packages/client/.eslintrc.cjs \
     yarn build client

FROM nginx:1.24.0-alpine
ARG PORT
WORKDIR /var/www/

COPY --from=base /usr/src/app/packages/client/build/ ./dist/
COPY --from=base /usr/src/app/node_modules/ ./node_modules/
COPY --chown=app:app ./docker/configs/client/nginx/templates/ /etc/nginx/templates/

HEALTHCHECK --interval=10s \
    --timeout=3s \
    --retries=5 \
    CMD node healthcheck.js

EXPOSE $PORT
CMD ["nginx", "-g", "daemon off;"]
